# 🚀 Chat4 快速部署指南

## 📋 一键部署

### 最简单的方式
```bash
# 1. 进入项目目录
cd Chat4

# 2. 运行自动化部署
npm run deploy

# 3. 按照提示选择配置
# 4. 等待部署完成
```

## 🛠️ 手动部署

### 方式1: 本地部署 (最快)

```bash
# 1. 启动Ollama (如果使用本地模型)
ollama serve

# 2. 安装依赖
npm install

# 3. 构建应用
npm run build
npm run db:generate

# 4. 启动应用
npm start

# 5. 访问
http://localhost:3000
```

### 方式2: PM2部署 (推荐生产环境)

```bash
# 1. 安装PM2
npm install -g pm2

# 2. 安装依赖并构建
npm install
npm run build
npm run db:generate

# 3. 启动应用
pm2 start "npm start" --name chat4

# 4. 查看状态
pm2 status

# 5. 查看日志
pm2 logs chat4
```

### 方式3: Docker部署 (最稳定)

```bash
# 1. 构建并启动
docker-compose up -d --build

# 2. 查看日志
docker-compose logs -f

# 3. 访问
http://localhost:3000
```

### 方式4: Vercel部署 (最简单)

```bash
# 1. 安装Vercel CLI
npm install -g vercel

# 2. 登录
vercel login

# 3. 部署
vercel --prod
```

## 🔧 配置选项

### 环境变量
创建 `.env` 文件：
```bash
NODE_ENV=production
PORT=3000
DATABASE_URL=file:./db/custom.db

# AI服务配置 (三选一)
# Ollama (本地模型)
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=llama2

# Z.ai (云服务)
ZAI_API_KEY=your_zai_key

# OpenAI (云服务)
OPENAI_API_KEY=your_openai_key
```

### 部署配置
创建 `deploy.config.json` 文件：
```json
{
  "deployment": {
    "type": "pm2", // local, pm2, docker, vercel
    "domain": "your-domain.com",
    "ssl": true,
    "ollama": true
  },
  "database": {
    "type": "sqlite", // sqlite, postgresql, mysql
    "url": "file:./db/custom.db"
  },
  "ai": {
    "provider": "ollama", // ollama, zai, openai
    "model": "llama2",
    "apiKey": ""
  }
}
```

## 🎯 推荐部署方案

### 开发/测试环境
**推荐**: 本地部署
```bash
npm run dev
```

### 小型生产环境
**推荐**: PM2部署
```bash
npm run deploy:pm2
```

### 中型生产环境
**推荐**: Docker部署
```bash
npm run deploy:docker
```

### 大型生产环境
**推荐**: Kubernetes + Docker
```bash
# 参考完整的部署指南
```

### 云平台部署
**推荐**: Vercel部署
```bash
npm run deploy:vercel
```

## 📊 部署后验证

### 1. 健康检查
```bash
curl http://localhost:3000/api/health
```

### 2. 基础测试
```bash
npm run test:basic
```

### 3. 功能测试
```bash
npm run test:e2e
```

### 4. 性能测试
```bash
npm run test:performance
```

## 🔧 常见问题

### 1. 端口冲突
```bash
# 检查端口占用
netstat -an | grep :3000

# 更改端口
export PORT=3001
npm start
```

### 2. Ollama连接失败
```bash
# 检查Ollama服务
curl http://localhost:11434/api/tags

# 重启Ollama
# Windows: 重启Ollama应用
# Linux/Mac: sudo systemctl restart ollama
```

### 3. 数据库问题
```bash
# 重新生成数据库
npm run db:generate

# 重置数据库
npm run db:reset
```

### 4. 内存不足
```bash
# 增加Node.js内存
export NODE_OPTIONS="--max-old-space-size=4096"
npm start
```

## 📈 监控和维护

### PM2监控
```bash
# 实时监控
pm2 monit

# 查看资源使用
pm2 info chat4

# 重启策略
pm2 describe chat4
```

### 日志管理
```bash
# 查看实时日志
pm2 logs chat4

# 日志轮转
pm2 install pm2-logrotate

# 清理日志
pm2 flush
```

### 备份策略
```bash
# 数据库备份
cp db/custom.db backup/custom_$(date +%Y%m%d).db

# 文件备份
tar -czf backup/storage_$(date +%Y%m%d).tar.gz storage/
```

## 🚀 高级部署

### 负载均衡
```nginx
upstream chat4_backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}

server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://chat4_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### SSL配置
```bash
# 使用Let's Encrypt
sudo certbot --nginx -d your-domain.com

# 自动续期
crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

### 集群部署
```bash
# PM2集群模式
pm2 start server.js -i max

# 或指定实例数
pm2 start server.js -i 4
```

---

## 🎉 总结

Chat4支持多种部署方式，从简单的本地部署到复杂的生产环境部署：

1. **快速开始**: `npm run deploy` 一键部署
2. **本地测试**: `npm start` 本地运行
3. **生产环境**: PM2/Docker/Vercel 部署
4. **企业级**: Kubernetes + 负载均衡

选择最适合你需求的部署方式，按照相应步骤进行配置和部署！