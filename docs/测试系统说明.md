# 🧪 本地模型自动化测试系统

## 📋 测试系统概述

本项目提供了完整的基于本地Ollama模型的端到端自动化测试系统，包括：

- **健康检查**: 系统状态和服务可用性检查
- **API测试**: 各个API端点的连接和功能测试
- **端到端测试**: 完整的聊天流程测试
- **性能测试**: 并发和压力测试
- **数据库测试**: 数据存储和检索测试
- **内存系统测试**: 角色记忆和对话历史测试

## 🚀 快速开始

### 1. 环境准备

确保以下服务已安装并运行：

```bash
# 检查Node.js版本
node --version  # 需要 >= 18.0.0

# 检查Ollama服务
curl http://localhost:11434/api/tags

# 启动项目服务器
npm run dev
```

### 2. 基本测试命令

```bash
# 健康检查
npm run test:health

# API连接测试
npm run test:api

# 端到端测试
npm run test:e2e

# 性能测试
npm run test:performance

# 快速测试（健康检查 + API测试）
npm run test:quick

# 完整测试（所有测试）
npm run test:all

# 全面测试（包含性能和数据库）
npm run test:full
```

### 3. 使用测试运行器

```bash
# 运行所有测试
node scripts/test-runner.js

# 运行特定测试
node scripts/test-runner.js --e2e --performance

# 查看帮助
node scripts/test-runner.js --help
```

## 📊 测试类型详解

### 1. 健康检查测试 (`test:health`)

检查系统各组件的健康状态：
- ✅ 数据库连接
- ✅ Ollama服务状态
- ✅ API配置状态
- ✅ 存储目录访问性

**输出示例：**
```json
{
  "status": "healthy",
  "database": "connected",
  "ollama": {
    "status": "connected",
    "models": 3,
    "available": ["llama2", "mistral", "codellama"]
  },
  "stats": {
    "characters": 5,
    "messages": 42,
    "themes": 3
  }
}
```

### 2. API连接测试 (`test:api`)

测试所有API端点的连接性：
- `/api/health` - 健康检查
- `/api/config` - 配置管理
- `/api/characters` - 角色管理
- `/api/themes` - 主题管理

### 3. 端到端测试 (`test:e2e`)

完整的聊天流程测试：
1. 创建测试主题
2. 创建测试角色
3. 初始化聊天室
4. 发送测试消息
5. 验证回复生成
6. 测试记忆系统
7. 清理测试数据

**测试流程：**
```
创建主题 → 创建角色 → 初始化聊天 → 发送消息 → 验证回复 → 测试记忆 → 清理数据
```

### 4. 性能测试 (`test:performance`)

系统性能和负载测试：
- **单请求性能**: 响应时间和吞吐量
- **并发测试**: 多用户同时访问
- **压力测试**: 持续高负载测试
- **模型对比**: 不同Ollama模型性能对比

**性能指标：**
- 响应时间 (ms)
- 吞吐量 (requests/second)
- 成功率 (%)
- 并发处理能力

### 5. 数据库测试 (`test:database`)

数据库操作测试：
- 连接稳定性
- CRUD操作
- 查询性能
- 数据完整性

### 6. 内存系统测试 (`test:memory`)

角色记忆系统测试：
- 记忆银行创建
- 对话历史存储
- 关键记忆提取
- 记忆检索性能

## ⚙️ 测试配置

### 测试配置文件 (`test-config.json`)

```json
{
  "services": {
    "ollama": {
      "baseUrl": "http://localhost:11434",
      "defaultModel": "llama2",
      "timeout": 30000
    }
  },
  "tests": {
    "e2e": {
      "enabled": true,
      "testMessages": ["测试消息1", "测试消息2"],
      "maxResponseTime": 30000
    },
    "performance": {
      "concurrentUsers": [1, 5, 10, 20],
      "testDuration": 30000
    }
  }
}
```

### 环境变量

```bash
# 数据库配置
DATABASE_URL="file:./db/custom.db"

# Ollama配置
OLLAMA_BASE_URL="http://localhost:11434"
OLLAMA_MODEL="llama2"

# 测试配置
TEST_TIMEOUT=30000
TEST_MAX_RETRIES=3
```

## 📈 测试报告

### 报告生成位置

所有测试报告会自动保存到 `test-reports/` 目录：
- `e2e-test-*.json` - 端到端测试报告
- `performance-test-*.json` - 性能测试报告
- `test-summary-*.json` - 综合测试总结

### 报告内容示例

```json
{
  "timestamp": "2024-01-20T10:30:00.000Z",
  "summary": {
    "totalTests": 6,
    "passedTests": 5,
    "failedTests": 1,
    "successRate": "83.3%"
  },
  "tests": [
    {
      "name": "服务器健康检查",
      "success": true
    },
    {
      "name": "端到端测试",
      "success": true,
      "report": {
        "chatResults": [
          {
            "message": "你好，我想了解AI测试",
            "responseTime": 2450,
            "success": true
          }
        ]
      }
    }
  ]
}
```

## 🔧 故障排除

### 常见问题

1. **Ollama连接失败**
   ```bash
   # 检查Ollama服务状态
   curl http://localhost:11434/api/tags
   
   # 重启Ollama服务
   sudo systemctl restart ollama
   ```

2. **数据库连接失败**
   ```bash
   # 检查数据库文件
   ls -la db/custom.db
   
   # 重新生成Prisma客户端
   npm run db:generate
   ```

3. **服务器启动失败**
   ```bash
   # 检查端口占用
   netstat -an | grep 3000
   
   # 清理并重新安装依赖
   rm -rf node_modules package-lock.json
   npm install
   ```

4. **测试超时**
   ```bash
   # 增加测试超时时间
   export TEST_TIMEOUT=60000
   
   # 检查系统资源
   htop
   ```

### 调试模式

启用详细日志输出：
```bash
# 启用调试模式
DEBUG=* node scripts/test-runner.js

# 查看详细日志
tail -f dev.log
```

## 🎯 最佳实践

### 1. 测试环境准备
- 确保Ollama服务正常运行
- 准备测试模型（llama2, mistral等）
- 清理测试数据避免干扰

### 2. 定期测试
- 每次代码变更后运行快速测试
- 发布前运行完整测试套件
- 定期性能测试监控系统健康

### 3. 性能监控
- 监控响应时间趋势
- 跟踪成功率变化
- 记录系统资源使用情况

### 4. 测试数据管理
- 定期清理测试报告
- 备份重要的测试结果
- 分析测试趋势和模式

## 📚 相关文档

- [项目升级总结](./docs/项目升级总结.md)
- [角色管理系统](./docs/角色管理系统.md)
- [目录结构说明](./docs/目录结构说明.md)
- [CRUSH开发指南](./CRUSH.md)

---

**提示**: 本测试系统专为本地Ollama模型优化，确保在运行测试前已正确配置本地环境。