# 🚀 Chat4 部署指南

## 📋 部署概述

Chat4 支持多种部署方式，从本地开发到生产环境，可以根据需求选择合适的部署方案。

## 🛠️ 部署前准备

### 系统要求
- **Node.js**: 18.0 或更高版本
- **npm**: 包管理器
- **Ollama**: 本地AI模型服务 (可选，用于本地LLM)
- **数据库**: SQLite (默认) 或 PostgreSQL/MySQL (生产环境)

### 环境检查
```bash
# 检查Node.js版本
node --version
npm --version

# 检查Ollama (如果使用本地LLM)
ollama --version
```

## 📦 构建应用

### 1. 安装依赖
```bash
cd Chat4
npm install
```

### 2. 构建生产版本
```bash
npm run build
npm run db:generate
```

### 3. 环境配置
```bash
# 复制环境变量模板
cp .env.example .env

# 编辑环境变量
nano .env
```

## 🚀 部署方式

### 方式1: 本地部署 (开发/测试)

#### 启动服务
```bash
# 启动Ollama (如果使用本地LLM)
ollama serve

# 启动应用
npm start

# 或使用开发模式
npm run dev
```

#### 访问应用
```
http://localhost:3000
```

### 方式2: PM2 进程管理 (推荐)

#### 安装PM2
```bash
npm install -g pm2
```

#### 创建PM2配置文件
```bash
# 创建 ecosystem.config.js
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'chat4',
    script: 'server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
}
EOF
```

#### 启动应用
```bash
# 启动应用
pm2 start ecosystem.config.js

# 查看状态
pm2 status

# 查看日志
pm2 logs chat4

# 重启应用
pm2 restart chat4

# 停止应用
pm2 stop chat4
```

#### 设置开机自启
```bash
# 保存PM2进程列表
pm2 save

# 生成开机启动脚本
pm2 startup

# 启用开机自启
pm2 unstartup startup
```

### 方式3: Docker 容器化部署

#### 创建Dockerfile
```dockerfile
# 构建阶段
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build
RUN npm run db:generate

# 生产阶段
FROM node:18-alpine AS runner

WORKDIR /app

# 复制构建结果
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/db ./db

# 安装生产依赖
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

# 创建非root用户
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# 设置权限
COPY --chown=nextjs:nodejs .next
COPY --chown=nextjs:nodejs db
USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
```

#### 创建docker-compose.yml
```yaml
version: '3.8'

services:
  chat4:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:/app/db/custom.db
    volumes:
      - ./db:/app/db
      - ./storage:/app/storage
    restart: unless-stopped
    depends_on:
      - ollama

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped

  # 可选: 使用PostgreSQL
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: chat4
      POSTGRES_USER: chat4
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

volumes:
  ollama_data:
  postgres_data:
```

#### 构建和启动
```bash
# 构建镜像
docker-compose build

# 启动服务
docker-compose up -d

# 查看日志
docker-compose logs -f

# 停止服务
docker-compose down
```

### 方式4: 云平台部署

#### Vercel 部署 (推荐)

1. **安装Vercel CLI**
```bash
npm i -g vercel
```

2. **项目配置**
```bash
# 登录Vercel
vercel login

# 部署项目
vercel

# 配置环境变量
vercel env add DATABASE_URL
vercel env add ZAI_API_KEY
vercel env add OPENAI_API_KEY
```

3. **自动部署**
```bash
# 每次推送到main分支自动部署
git push origin main
```

#### Railway 部署

1. **安装Railway CLI**
```bash
npm install -g @railway/cli
```

2. **部署项目**
```bash
# 登录Railway
railway login

# 初始化项目
railway init

# 部署
railway up
```

#### 其他云平台
- **Netlify**: 适合静态站点
- **Heroku**: 适合Node.js应用
- **AWS Elastic Beanstalk**: 企业级部署
- **Google Cloud Run**: 容器化部署

### 方式5: 传统服务器部署

#### 系统准备 (Ubuntu/Debian)
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 安装PM2
sudo npm install -g pm2

# 安装Nginx
sudo apt install -y nginx
```

#### 部署应用
```bash
# 创建应用目录
sudo mkdir -p /var/www/chat4
sudo chown $USER:$USER /var/www/chat4

# 复制项目文件
cp -r . /var/www/chat4/
cd /var/www/chat4

# 安装依赖
npm install --production

# 构建应用
npm run build
npm run db:generate

# 配置PM2
pm2 start ecosystem.config.js

# 配置Nginx
sudo tee /etc/nginx/sites-available/chat4 << EOF
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF

# 启用站点
sudo ln -s /etc/nginx/sites-available/chat4 /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### 配置SSL (Let's Encrypt)
```bash
# 安装Certbot
sudo apt install certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

## 🔧 配置管理

### 环境变量
```bash
# .env 文件
NODE_ENV=production
PORT=3000
HOSTNAME=0.0.0.0

# 数据库配置
DATABASE_URL=file:./db/custom.db
# 或 PostgreSQL: postgresql://user:password@localhost:5432/chat4

# AI服务配置
ZAI_API_KEY=your_zai_api_key
OPENAI_API_KEY=your_openai_api_key

# Ollama配置
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=llama2

# 安全配置
JWT_SECRET=your_jwt_secret
SESSION_SECRET=your_session_secret
```

### 数据库迁移
```bash
# SQLite (默认)
npm run db:push

# PostgreSQL
npm run db:migrate

# 重置数据库
npm run db:reset
```

## 📊 监控和维护

### 应用监控
```bash
# PM2监控
pm2 monit

# 查看资源使用
pm2 info chat4

# 重启策略
pm2 describe chat4
```

### 日志管理
```bash
# 查看实时日志
pm2 logs chat4

# 日志轮转
pm2 install pm2-logrotate

# 清理旧日志
pm2 flush
```

### 备份策略
```bash
# 数据库备份
#!/bin/bash
BACKUP_DIR="/backups/chat4"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# SQLite备份
cp db/custom.db $BACKUP_DIR/custom_$DATE.db

# 文件存储备份
tar -czf $BACKUP_DIR/storage_$DATE.tar.gz storage/

# 清理30天前的备份
find $BACKUP_DIR -name "*.db" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete
```

### 性能优化
```bash
# Node.js优化
export NODE_OPTIONS="--max-old-space-size=4096"

# PM2集群模式
pm2 scale chat4 4

# Nginx优化 (添加到nginx.conf)
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
```

## 🚨 故障排除

### 常见问题

#### 1. 端口冲突
```bash
# 查看端口占用
sudo netstat -tulpn | grep :3000

# 更改端口
export PORT=3001
pm2 restart chat4
```

#### 2. 内存不足
```bash
# 增加内存限制
export NODE_OPTIONS="--max-old-space-size=8192"
pm2 restart chat4
```

#### 3. 数据库连接失败
```bash
# 检查数据库文件
ls -la db/custom.db

# 重新生成Prisma客户端
npm run db:generate

# 重置数据库
npm run db:reset
```

#### 4. Ollama连接失败
```bash
# 检查Ollama服务
curl http://localhost:11434/api/tags

# 重启Ollama
sudo systemctl restart ollama
```

### 健康检查
```bash
# 应用健康检查
curl http://localhost:3000/api/health

# 数据库连接测试
npm run test:basic

# 完整测试
npm run test:all
```

## 📈 扩展部署

### 负载均衡
```nginx
upstream chat4_backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}

server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://chat4_backend;
        # ... 其他代理配置
    }
}
```

### 微服务架构
```yaml
# docker-compose.microservices.yml
version: '3.8'

services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
  
  backend:
    build: ./backend
    ports:
      - "3001:3001"
  
  chat-service:
    build: ./chat-service
    ports:
      - "3002:3002"
  
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
```

### Kubernetes部署
```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chat4
spec:
  replicas: 3
  selector:
    matchLabels:
      app: chat4
  template:
    metadata:
      labels:
        app: chat4
    spec:
      containers:
      - name: chat4
        image: chat4:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
```

---

## 🎯 部署建议

### 开发环境
- 使用 `npm run dev` 进行本地开发
- 配置热重载和调试工具

### 测试环境
- 使用 PM2 管理进程
- 配置完整的测试数据
- 启用详细日志

### 生产环境
- 使用 Docker 或 PM2 部署
- 配置 Nginx 反向代理
- 启用 SSL 和安全设置
- 配置监控和备份

### 企业环境
- 使用 Kubernetes 进行容器编排
- 配置负载均衡和高可用
- 实施完整的监控和告警
- 配置灾难恢复方案

选择最适合你需求的部署方式，并按照相应的步骤进行配置和部署！