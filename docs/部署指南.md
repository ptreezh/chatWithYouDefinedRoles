# ðŸš€ Chat4 éƒ¨ç½²æŒ‡å—

## ðŸ“‹ éƒ¨ç½²æ¦‚è¿°

Chat4 æ”¯æŒå¤šç§éƒ¨ç½²æ–¹å¼ï¼Œä»Žæœ¬åœ°å¼€å‘åˆ°ç”Ÿäº§çŽ¯å¢ƒï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚é€‰æ‹©åˆé€‚çš„éƒ¨ç½²æ–¹æ¡ˆã€‚

## ðŸ› ï¸ éƒ¨ç½²å‰å‡†å¤‡

### ç³»ç»Ÿè¦æ±‚
- **Node.js**: 18.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **npm**: åŒ…ç®¡ç†å™¨
- **Ollama**: æœ¬åœ°AIæ¨¡åž‹æœåŠ¡ (å¯é€‰ï¼Œç”¨äºŽæœ¬åœ°LLM)
- **æ•°æ®åº“**: SQLite (é»˜è®¤) æˆ– PostgreSQL/MySQL (ç”Ÿäº§çŽ¯å¢ƒ)

### çŽ¯å¢ƒæ£€æŸ¥
```bash
# æ£€æŸ¥Node.jsç‰ˆæœ¬
node --version
npm --version

# æ£€æŸ¥Ollama (å¦‚æžœä½¿ç”¨æœ¬åœ°LLM)
ollama --version
```

## ðŸ“¦ æž„å»ºåº”ç”¨

### 1. å®‰è£…ä¾èµ–
```bash
cd Chat4
npm install
```

### 2. æž„å»ºç”Ÿäº§ç‰ˆæœ¬
```bash
npm run build
npm run db:generate
```

### 3. çŽ¯å¢ƒé…ç½®
```bash
# å¤åˆ¶çŽ¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘çŽ¯å¢ƒå˜é‡
nano .env
```

## ðŸš€ éƒ¨ç½²æ–¹å¼

### æ–¹å¼1: æœ¬åœ°éƒ¨ç½² (å¼€å‘/æµ‹è¯•)

#### å¯åŠ¨æœåŠ¡
```bash
# å¯åŠ¨Ollama (å¦‚æžœä½¿ç”¨æœ¬åœ°LLM)
ollama serve

# å¯åŠ¨åº”ç”¨
npm start

# æˆ–ä½¿ç”¨å¼€å‘æ¨¡å¼
npm run dev
```

#### è®¿é—®åº”ç”¨
```
http://localhost:3000
```

### æ–¹å¼2: PM2 è¿›ç¨‹ç®¡ç† (æŽ¨è)

#### å®‰è£…PM2
```bash
npm install -g pm2
```

#### åˆ›å»ºPM2é…ç½®æ–‡ä»¶
```bash
# åˆ›å»º ecosystem.config.js
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'chat4',
    script: 'server.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true
  }]
}
EOF
```

#### å¯åŠ¨åº”ç”¨
```bash
# å¯åŠ¨åº”ç”¨
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs chat4

# é‡å¯åº”ç”¨
pm2 restart chat4

# åœæ­¢åº”ç”¨
pm2 stop chat4
```

#### è®¾ç½®å¼€æœºè‡ªå¯
```bash
# ä¿å­˜PM2è¿›ç¨‹åˆ—è¡¨
pm2 save

# ç”Ÿæˆå¼€æœºå¯åŠ¨è„šæœ¬
pm2 startup

# å¯ç”¨å¼€æœºè‡ªå¯
pm2 unstartup startup
```

### æ–¹å¼3: Docker å®¹å™¨åŒ–éƒ¨ç½²

#### åˆ›å»ºDockerfile
```dockerfile
# æž„å»ºé˜¶æ®µ
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build
RUN npm run db:generate

# ç”Ÿäº§é˜¶æ®µ
FROM node:18-alpine AS runner

WORKDIR /app

# å¤åˆ¶æž„å»ºç»“æžœ
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public
COPY --from=builder /app/prisma ./prisma
COPY --from=builder /app/db ./db

# å®‰è£…ç”Ÿäº§ä¾èµ–
COPY package*.json ./
RUN npm ci --only=production && npm cache clean --force

# åˆ›å»ºéžrootç”¨æˆ·
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

# è®¾ç½®æƒé™
COPY --chown=nextjs:nodejs .next
COPY --chown=nextjs:nodejs db
USER nextjs

EXPOSE 3000

ENV PORT 3000
ENV HOSTNAME "0.0.0.0"

CMD ["node", "server.js"]
```

#### åˆ›å»ºdocker-compose.yml
```yaml
version: '3.8'

services:
  chat4:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=file:/app/db/custom.db
    volumes:
      - ./db:/app/db
      - ./storage:/app/storage
    restart: unless-stopped
    depends_on:
      - ollama

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    restart: unless-stopped

  # å¯é€‰: ä½¿ç”¨PostgreSQL
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: chat4
      POSTGRES_USER: chat4
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

volumes:
  ollama_data:
  postgres_data:
```

#### æž„å»ºå’Œå¯åŠ¨
```bash
# æž„å»ºé•œåƒ
docker-compose build

# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f

# åœæ­¢æœåŠ¡
docker-compose down
```

### æ–¹å¼4: äº‘å¹³å°éƒ¨ç½²

#### Vercel éƒ¨ç½² (æŽ¨è)

1. **å®‰è£…Vercel CLI**
```bash
npm i -g vercel
```

2. **é¡¹ç›®é…ç½®**
```bash
# ç™»å½•Vercel
vercel login

# éƒ¨ç½²é¡¹ç›®
vercel

# é…ç½®çŽ¯å¢ƒå˜é‡
vercel env add DATABASE_URL
vercel env add ZAI_API_KEY
vercel env add OPENAI_API_KEY
```

3. **è‡ªåŠ¨éƒ¨ç½²**
```bash
# æ¯æ¬¡æŽ¨é€åˆ°mainåˆ†æ”¯è‡ªåŠ¨éƒ¨ç½²
git push origin main
```

#### Railway éƒ¨ç½²

1. **å®‰è£…Railway CLI**
```bash
npm install -g @railway/cli
```

2. **éƒ¨ç½²é¡¹ç›®**
```bash
# ç™»å½•Railway
railway login

# åˆå§‹åŒ–é¡¹ç›®
railway init

# éƒ¨ç½²
railway up
```

#### å…¶ä»–äº‘å¹³å°
- **Netlify**: é€‚åˆé™æ€ç«™ç‚¹
- **Heroku**: é€‚åˆNode.jsåº”ç”¨
- **AWS Elastic Beanstalk**: ä¼ä¸šçº§éƒ¨ç½²
- **Google Cloud Run**: å®¹å™¨åŒ–éƒ¨ç½²

### æ–¹å¼5: ä¼ ç»ŸæœåŠ¡å™¨éƒ¨ç½²

#### ç³»ç»Ÿå‡†å¤‡ (Ubuntu/Debian)
```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£…Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# å®‰è£…PM2
sudo npm install -g pm2

# å®‰è£…Nginx
sudo apt install -y nginx
```

#### éƒ¨ç½²åº”ç”¨
```bash
# åˆ›å»ºåº”ç”¨ç›®å½•
sudo mkdir -p /var/www/chat4
sudo chown $USER:$USER /var/www/chat4

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
cp -r . /var/www/chat4/
cd /var/www/chat4

# å®‰è£…ä¾èµ–
npm install --production

# æž„å»ºåº”ç”¨
npm run build
npm run db:generate

# é…ç½®PM2
pm2 start ecosystem.config.js

# é…ç½®Nginx
sudo tee /etc/nginx/sites-available/chat4 << EOF
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_cache_bypass \$http_upgrade;
    }
}
EOF

# å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/chat4 /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

#### é…ç½®SSL (Let's Encrypt)
```bash
# å®‰è£…Certbot
sudo apt install certbot python3-certbot-nginx

# èŽ·å–SSLè¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo crontab -e
# æ·»åŠ : 0 12 * * * /usr/bin/certbot renew --quiet
```

## ðŸ”§ é…ç½®ç®¡ç†

### çŽ¯å¢ƒå˜é‡
```bash
# .env æ–‡ä»¶
NODE_ENV=production
PORT=3000
HOSTNAME=0.0.0.0

# æ•°æ®åº“é…ç½®
DATABASE_URL=file:./db/custom.db
# æˆ– PostgreSQL: postgresql://user:password@localhost:5432/chat4

# AIæœåŠ¡é…ç½®
ZAI_API_KEY=your_zai_api_key
OPENAI_API_KEY=your_openai_api_key

# Ollamaé…ç½®
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=llama2

# å®‰å…¨é…ç½®
JWT_SECRET=your_jwt_secret
SESSION_SECRET=your_session_secret
```

### æ•°æ®åº“è¿ç§»
```bash
# SQLite (é»˜è®¤)
npm run db:push

# PostgreSQL
npm run db:migrate

# é‡ç½®æ•°æ®åº“
npm run db:reset
```

## ðŸ“Š ç›‘æŽ§å’Œç»´æŠ¤

### åº”ç”¨ç›‘æŽ§
```bash
# PM2ç›‘æŽ§
pm2 monit

# æŸ¥çœ‹èµ„æºä½¿ç”¨
pm2 info chat4

# é‡å¯ç­–ç•¥
pm2 describe chat4
```

### æ—¥å¿—ç®¡ç†
```bash
# æŸ¥çœ‹å®žæ—¶æ—¥å¿—
pm2 logs chat4

# æ—¥å¿—è½®è½¬
pm2 install pm2-logrotate

# æ¸…ç†æ—§æ—¥å¿—
pm2 flush
```

### å¤‡ä»½ç­–ç•¥
```bash
# æ•°æ®åº“å¤‡ä»½
#!/bin/bash
BACKUP_DIR="/backups/chat4"
DATE=$(date +%Y%m%d_%H%M%S)
mkdir -p $BACKUP_DIR

# SQLiteå¤‡ä»½
cp db/custom.db $BACKUP_DIR/custom_$DATE.db

# æ–‡ä»¶å­˜å‚¨å¤‡ä»½
tar -czf $BACKUP_DIR/storage_$DATE.tar.gz storage/

# æ¸…ç†30å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.db" -mtime +30 -delete
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete
```

### æ€§èƒ½ä¼˜åŒ–
```bash
# Node.jsä¼˜åŒ–
export NODE_OPTIONS="--max-old-space-size=4096"

# PM2é›†ç¾¤æ¨¡å¼
pm2 scale chat4 4

# Nginxä¼˜åŒ– (æ·»åŠ åˆ°nginx.conf)
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
```

## ðŸš¨ æ•…éšœæŽ’é™¤

### å¸¸è§é—®é¢˜

#### 1. ç«¯å£å†²çª
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
sudo netstat -tulpn | grep :3000

# æ›´æ”¹ç«¯å£
export PORT=3001
pm2 restart chat4
```

#### 2. å†…å­˜ä¸è¶³
```bash
# å¢žåŠ å†…å­˜é™åˆ¶
export NODE_OPTIONS="--max-old-space-size=8192"
pm2 restart chat4
```

#### 3. æ•°æ®åº“è¿žæŽ¥å¤±è´¥
```bash
# æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
ls -la db/custom.db

# é‡æ–°ç”ŸæˆPrismaå®¢æˆ·ç«¯
npm run db:generate

# é‡ç½®æ•°æ®åº“
npm run db:reset
```

#### 4. Ollamaè¿žæŽ¥å¤±è´¥
```bash
# æ£€æŸ¥OllamaæœåŠ¡
curl http://localhost:11434/api/tags

# é‡å¯Ollama
sudo systemctl restart ollama
```

### å¥åº·æ£€æŸ¥
```bash
# åº”ç”¨å¥åº·æ£€æŸ¥
curl http://localhost:3000/api/health

# æ•°æ®åº“è¿žæŽ¥æµ‹è¯•
npm run test:basic

# å®Œæ•´æµ‹è¯•
npm run test:all
```

## ðŸ“ˆ æ‰©å±•éƒ¨ç½²

### è´Ÿè½½å‡è¡¡
```nginx
upstream chat4_backend {
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    server 127.0.0.1:3002;
}

server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://chat4_backend;
        # ... å…¶ä»–ä»£ç†é…ç½®
    }
}
```

### å¾®æœåŠ¡æž¶æž„
```yaml
# docker-compose.microservices.yml
version: '3.8'

services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
  
  backend:
    build: ./backend
    ports:
      - "3001:3001"
  
  chat-service:
    build: ./chat-service
    ports:
      - "3002:3002"
  
  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
```

### Kuberneteséƒ¨ç½²
```yaml
# deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: chat4
spec:
  replicas: 3
  selector:
    matchLabels:
      app: chat4
  template:
    metadata:
      labels:
        app: chat4
    spec:
      containers:
      - name: chat4
        image: chat4:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
```

---

## ðŸŽ¯ éƒ¨ç½²å»ºè®®

### å¼€å‘çŽ¯å¢ƒ
- ä½¿ç”¨ `npm run dev` è¿›è¡Œæœ¬åœ°å¼€å‘
- é…ç½®çƒ­é‡è½½å’Œè°ƒè¯•å·¥å…·

### æµ‹è¯•çŽ¯å¢ƒ
- ä½¿ç”¨ PM2 ç®¡ç†è¿›ç¨‹
- é…ç½®å®Œæ•´çš„æµ‹è¯•æ•°æ®
- å¯ç”¨è¯¦ç»†æ—¥å¿—

### ç”Ÿäº§çŽ¯å¢ƒ
- ä½¿ç”¨ Docker æˆ– PM2 éƒ¨ç½²
- é…ç½® Nginx åå‘ä»£ç†
- å¯ç”¨ SSL å’Œå®‰å…¨è®¾ç½®
- é…ç½®ç›‘æŽ§å’Œå¤‡ä»½

### ä¼ä¸šçŽ¯å¢ƒ
- ä½¿ç”¨ Kubernetes è¿›è¡Œå®¹å™¨ç¼–æŽ’
- é…ç½®è´Ÿè½½å‡è¡¡å’Œé«˜å¯ç”¨
- å®žæ–½å®Œæ•´çš„ç›‘æŽ§å’Œå‘Šè­¦
- é…ç½®ç¾éš¾æ¢å¤æ–¹æ¡ˆ

é€‰æ‹©æœ€é€‚åˆä½ éœ€æ±‚çš„éƒ¨ç½²æ–¹å¼ï¼Œå¹¶æŒ‰ç…§ç›¸åº”çš„æ­¥éª¤è¿›è¡Œé…ç½®å’Œéƒ¨ç½²ï¼